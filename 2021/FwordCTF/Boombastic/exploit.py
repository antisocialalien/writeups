#!/usr/bin/python3

from pwn import *
from Crypto.Util.number import getStrongPrime, inverse
from json import loads, dumps
import hashlib, random, sys, os

#con = remote('52.149.135.130', 4872)
con = process('./boombastic.py')

def get_ticket(code, secret, p):
    y = int(hashlib.sha256(code.encode()).hexdigest(),16)
    r = ((y**2 - 1) * (inverse(secret**2, p))) % p
    s = ((1 + y) * (inverse(secret, p))) % p
    return {'s': hex(s), 'r': hex(r), 'p': hex(p)}

if __name__ == "__main__":
    con.recvuntil(b'> ')
    con.send(b'2\n')
    some_ticket = loads(con.recvuntil(b'}')[15:])

    s = int(some_ticket['s'], 16)
    r = int(some_ticket['r'], 16)
    p = int(some_ticket['p'], 16)

    y = ((-(s**2) - r) * inverse(r - s**2, p)) % p
    secret_inv = (s * inverse(y+1, p)) % p
    secret_orig = inverse(secret_inv,p)

    forged_ticket = get_ticket("Boombastic", secret_orig, p)

    con.recvuntil(b'> ')
    con.send(b'1\n')
    con.recvuntil(b'Enter the magic word : ')
    con.send(str.encode(dumps(forged_ticket)) + b'\n')
    flag = con.recvline()

    print(flag)
